<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>um produto orientado a dados governamentais: parte 5 | o eu anal√≠tico</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="um produto orientado a dados governamentais: parte 5" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="fastapi, docker, cloud e tudo o mais para o deploy." />
<meta property="og:description" content="fastapi, docker, cloud e tudo o mais para o deploy." />
<link rel="canonical" href="https://netoferraz.github.io/o-eu-analitico/deep%20learning/nlp/data%20product/fastapi/docker/cloud/azure/2020/08/03/gov-data-product-p5.html" />
<meta property="og:url" content="https://netoferraz.github.io/o-eu-analitico/deep%20learning/nlp/data%20product/fastapi/docker/cloud/azure/2020/08/03/gov-data-product-p5.html" />
<meta property="og:site_name" content="o eu anal√≠tico" />
<meta property="og:image" content="https://netoferraz.github.io/o-eu-analitico/images/posts/govdata_poc_5/govdata_poc_minor_p5.png" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-08-03T00:00:00-05:00" />
<script type="application/ld+json">
{"mainEntityOfPage":{"@type":"WebPage","@id":"https://netoferraz.github.io/o-eu-analitico/deep%20learning/nlp/data%20product/fastapi/docker/cloud/azure/2020/08/03/gov-data-product-p5.html"},"url":"https://netoferraz.github.io/o-eu-analitico/deep%20learning/nlp/data%20product/fastapi/docker/cloud/azure/2020/08/03/gov-data-product-p5.html","@type":"BlogPosting","headline":"um produto orientado a dados governamentais: parte 5","dateModified":"2020-08-03T00:00:00-05:00","datePublished":"2020-08-03T00:00:00-05:00","image":"https://netoferraz.github.io/o-eu-analitico/images/posts/govdata_poc_5/govdata_poc_minor_p5.png","description":"fastapi, docker, cloud e tudo o mais para o deploy.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/o-eu-analitico/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://netoferraz.github.io/o-eu-analitico/feed.xml" title="o eu anal√≠tico" /><!-- the google_analytics_id gets auto inserted from the config file -->



<script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','//www.google-analytics.com/analytics.js','ga');ga('create','UA-134149444-2','auto');ga('require','displayfeatures');ga('send','pageview');</script>

<link rel="shortcut icon" type="image/x-icon" href="/o-eu-analitico/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" /><script src="https://hypothes.is/embed.js" async></script>

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/o-eu-analitico/">o eu anal√≠tico</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/o-eu-analitico/about/">sobre</a><a class="page-link" href="/o-eu-analitico/search/">pesquisa</a><a class="page-link" href="/o-eu-analitico/categories/">tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">um produto orientado a dados governamentais: parte 5</h1><p class="page-description">fastapi, docker, cloud e tudo o mais para o deploy.</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2020-08-03T00:00:00-05:00" itemprop="datePublished">
        Aug 3, 2020
      </time>
       ‚Ä¢ <span class="read-time" title="Estimated read time">
    
    
      6 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/o-eu-analitico/categories/#deep learning">deep learning</a>
        &nbsp;
      
        <a class="category-tags-link" href="/o-eu-analitico/categories/#nlp">nlp</a>
        &nbsp;
      
        <a class="category-tags-link" href="/o-eu-analitico/categories/#data product">data product</a>
        &nbsp;
      
        <a class="category-tags-link" href="/o-eu-analitico/categories/#fastapi">fastapi</a>
        &nbsp;
      
        <a class="category-tags-link" href="/o-eu-analitico/categories/#docker">docker</a>
        &nbsp;
      
        <a class="category-tags-link" href="/o-eu-analitico/categories/#cloud">cloud</a>
        &nbsp;
      
        <a class="category-tags-link" href="/o-eu-analitico/categories/#azure">azure</a>
        
      
      </p>
    

    
      
        <div class="pb-5 d-flex flex-wrap flex-justify-end">
          <div class="px-2">

    <a href="https://github.com/netoferraz/o-eu-analitico/tree/master/_notebooks/2020-08-03-gov-data-product-p5.ipynb" role="button" target="_blank">
<img class="notebook-badge-image" src="/o-eu-analitico/assets/badges/github.svg" alt="View On GitHub">
    </a>
</div>

          <div class="px-2">
    <a href="https://mybinder.org/v2/gh/netoferraz/o-eu-analitico/master?filepath=_notebooks%2F2020-08-03-gov-data-product-p5.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/o-eu-analitico/assets/badges/binder.svg" alt="Open In Binder"/>
    </a>
</div>

          <div class="px-2">
    <a href="https://colab.research.google.com/github/netoferraz/o-eu-analitico/blob/master/_notebooks/2020-08-03-gov-data-product-p5.ipynb" target="_blank">
        <img class="notebook-badge-image" src="/o-eu-analitico/assets/badges/colab.svg" alt="Open In Colab"/>
    </a>
</div>
        </div>
      </header>

  <div class="post-content e-content" itemprop="articleBody">
    <!--
#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: _notebooks/2020-08-03-gov-data-product-p5.ipynb
-->

<div class="container" id="notebook-container">
        
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Esse √© o sexto post de uma s√©rie de como construir um produto data-driven de ponta a ponta, caso voc√™ ainda n√£o tenha acompanhado os demais, abaixo segue uma s√≠ntese com os respectivos links üòÄ.</p>
<ol>
<li>Em <a href="/o-eu-analitico/o-eu-analitico/dados%20abertos/governo/crawler/2020/07/07/metadados-normativos-federais.html">metadados de normas jur√≠dicas federais</a> coletamos dados do sistema LexML.</li>
<li>Em <a href="/o-eu-analitico/o-eu-analitico/machine%20learning/dados%20abertos/data%20product/2020/07/12/gov-data-product.html">um produto orientado a dados governamentais: parte 1</a> realizamos uma an√°lise explorat√≥ria dos dados e definimos um recorte e um escopo para os dados do projeto.</li>
<li>Em <a href="/o-eu-analitico/o-eu-analitico/machine%20learning/dados%20abertos/data%20product/2020/07/20/gov-data-product-p2.html">um produto orientado a dados governamentais: parte 2</a> realizamos a defini√ß√£o dos dos datasets de treino, valida√ß√£o e teste</li>
<li>Em <a href="/o-eu-analitico/o-eu-analitico/machine%20learning/data%20science/data%20product/2020/07/26/gov-data-product-p3.html">um produto orientado a dados governamentais: parte 3</a> detalhamos tudo que n√£o deu certo no treinamento de modelos de machine learning.</li>
<li>Em <a href="/o-eu-analitico/o-eu-analitico/deep%20learning/nlp/data%20product/2020/07/30/gov-data-product-p4.html">um produto orientado a dados governamentais: parte 4</a> apresentamos o treinamento de um modelo de deep learning</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Dando continuidade ao nosso projeto, chegamos na etapa de <em>deploy</em> do <a href="/o-eu-analitico/o-eu-analitico/deep%20learning/nlp/data%20product/2020/07/30/gov-data-product-p4.html">modelo treinado</a>. Os artefatos necess√°rios para colocar em produ√ß√£o o nosso modelo s√£o os seguintes arquivos:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>O encoder multilabel utilizado no treinamento: <a href="https://drive.google.com/uc?id=1-1K0jcHICzjgcaY64UeLC_PuEN5tI_Xa">MultiLabelBinarizer</a> </li>
<li>Os dados do modelo e vocabul√°rio do sentencepiece (<a href="https://drive.google.com/uc?id=1CyT0AI_PdWDZrnful6jBXFqAOfTrIOSe">spm.model</a> e <a href="https://drive.google.com/uc?id=1bGetu3Uzq06OrtdvVmRfiY6uorVSayIS">spm.vocab</a>)</li>
<li>O modelo de classifica√ß√£o treinado (<a href="https://drive.google.com/uc?id=1R6Mm_K2ARMjNEuTikMmpHO0goggh0Rg9">trained_model_fp32_fwd_classifier.pkl</a>)</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>√â importante ressaltar que o nosso treinamento foi realizado com GPU fazendo uso de <a href="https://forums.fast.ai/t/mixed-precision-training/20720">half-precision</a> (fp16) e a m√°quina que iremos realizar o deploy n√£o ser√° alocado GPU, portanto, a infer√™ncia ser√° realizada com CPU. Assim, foi necess√°rio converter o modelo para <a href="https://docs.fast.ai/basic_train.html#to_fp32">fp32</a>, o que fez o tamanho do nosso modelo dobrar de tamanho (176M).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Dito isso, criamos um <a href="https://github.com/netoferraz/backend_datagovprod">reposit√≥rio</a> no github para a api do nosso projeto. A pr√≥xima etapa √© definir em qual framework ser√° constru√≠da a api e depois de avaliar algumas das op√ß√µes dispon√≠veis foi decidido fazer uso da <a href="https://fastapi.tiangolo.com/">fastapi</a>, que √© um projeto muito parecido com <a href="https://flask.palletsprojects.com/en/1.1.x/">flask</a> s√≥ que incorpora v√°rios benef√≠cios do uso de <a href="https://docs.python.org/3/library/typing.html">type annotation</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A estrutura inicial do <em>backend</em> est√° definida abaixo:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>.
|____processor
| |____encoder.py
| |____sp.py
|____.gitignore
|____main.py
|____inference
| |____predict.py
|____LICENSE
|____README.md
|____models
| |____model.py
| |____download.py
|____artifacts
|____requirements.txt
|____.env</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Vamos definir as depend√™ncias do projeto no <code>requirements.txt</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>fastai==1.0.61
fastapi==0.60.1
uvicorn==0.11.8
sentencepiece==0.1.91
scikit-learn==0.22.2
numpy==1.19.1
python-dotenv==0.14.0
gdown==3.12.0</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Em seguida, iremos definir algumas vari√°veis de ambiente para o projeto (<code>.env</code>)</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>artifactsPath=./artifacts/
modelFileName=trained_model_fp32_fwd_classifier.pkl
mlbinarizerFileName=onehot.pkl
spmodelFileName=spm.model
spmodelVocabFileName=spm.vocab</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>O ambiente computacional (<a href="https://colab.research.google.com/">colab</a>) utilizado para o treinamento do nosso classificador n√£o ser√° o mesmo do deploy. Portanto, na inst√¢ncia do objeto <a href="https://docs.fast.ai/basic_train.html#Learner">Learner</a> precisamos alterar o path do modelo e do vocabul√°rio do <a href="https://docs.fast.ai/text.data.html#SPProcessor">Sentence Piece Processor</a>. Portanto, vamos escrever um c√≥digo para realizar essa modifica√ß√£o (<code>./processor/sp.py</code>)</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">fastai.text</span> <span class="kn">import</span> <span class="n">SPProcessor</span>
<span class="kn">from</span> <span class="nn">fastai.basic_train</span> <span class="kn">import</span> <span class="n">Learner</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>


<span class="k">def</span> <span class="nf">_fix_sp_processor</span><span class="p">(</span>
    <span class="n">learner</span><span class="p">:</span> <span class="n">Learner</span><span class="p">,</span> <span class="n">sp_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">sp_model</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">sp_vocab</span><span class="p">:</span> <span class="nb">str</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Fixes SentencePiece paths serialized into the model.</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    learner</span>
<span class="sd">        Learner object</span>
<span class="sd">    sp_path</span>
<span class="sd">        path to the directory containing the SentencePiece model and vocabulary files.</span>
<span class="sd">    sp_model</span>
<span class="sd">        SentencePiece model filename.</span>
<span class="sd">    sp_vocab</span>
<span class="sd">        SentencePiece vocabulary filename.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">processor</span> <span class="ow">in</span> <span class="n">learner</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">processor</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">processor</span><span class="p">,</span> <span class="n">SPProcessor</span><span class="p">):</span>
            <span class="n">processor</span><span class="o">.</span><span class="n">sp_model</span> <span class="o">=</span> <span class="n">sp_path</span> <span class="o">/</span> <span class="n">sp_model</span>
            <span class="n">processor</span><span class="o">.</span><span class="n">sp_vocab</span> <span class="o">=</span> <span class="n">sp_path</span> <span class="o">/</span> <span class="n">sp_vocab</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Precisamos tamb√©m definir um c√≥digo para carregar a inst√¢ncia do <a href="https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.MultiLabelBinarizer.html">MultiLabelBinarizer</a> usada no treinamento do modelo (<code>./processor/encoder.py</code>).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>  <span class="c1"># &quot;error&quot;, &quot;ignore&quot;, &quot;always&quot;, &quot;default&quot;, &quot;module&quot;</span>
<span class="n">load_dotenv</span><span class="p">()</span>

<span class="n">artifactsPath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;artifactsPath&quot;</span><span class="p">))</span>
<span class="n">mlBinarizerFileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;mlbinarizerFileName&quot;</span><span class="p">)</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">artifactsPath</span> <span class="o">/</span> <span class="n">mlBinarizerFileName</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">onehot</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Tomamos a decis√£o de n√£o subir para o reposit√≥rio os artefatos, principalmente, o classificador j√° que esse excedia os limites de tamanho permitidos pelo servi√ßo gratuito. Portanto, foi necess√°rio escrever uma rotina para baix√°-los (<code>./models/download.py</code>).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">import</span> <span class="nn">gdown</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">artifactsPath</span> <span class="o">=</span> <span class="s1">&#39;./artifacts&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">artifactsPath</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">artifactsPath</span><span class="p">)</span>
<span class="c1"># one hot encoder</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;./artifacts/onehot.pkl&quot;</span><span class="p">):</span>
    <span class="n">gdown</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://drive.google.com/uc?id=1-1K0jcHICzjgcaY64UeLC_PuEN5tI_Xa&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;./onehot.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;./artifacts/onehot.pkl&quot;</span><span class="p">)</span>

<span class="c1"># spm model</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;./artifacts/spm.model&quot;</span><span class="p">):</span>
    <span class="n">gdown</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://drive.google.com/uc?id=1CyT0AI_PdWDZrnful6jBXFqAOfTrIOSe&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;./spm.model&quot;</span><span class="p">,</span> <span class="s2">&quot;./artifacts/spm.model&quot;</span><span class="p">)</span>

<span class="c1"># spm vocab</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;./artifacts/spm.vocab&quot;</span><span class="p">):</span>
    <span class="n">gdown</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://drive.google.com/uc?id=1bGetu3Uzq06OrtdvVmRfiY6uorVSayIS&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="s2">&quot;./spm.vocab&quot;</span><span class="p">,</span> <span class="s2">&quot;./artifacts/spm.vocab&quot;</span><span class="p">)</span>

<span class="c1"># trained_model_fp32_fwd_classifier</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="s2">&quot;./artifacts/trained_model_fp32_fwd_classifier.pkl&quot;</span><span class="p">):</span>
    <span class="n">gdown</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s2">&quot;https://drive.google.com/uc?id=1R6Mm_K2ARMjNEuTikMmpHO0goggh0Rg9&quot;</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
        <span class="s2">&quot;./trained_model_fp32_fwd_classifier.pkl&quot;</span><span class="p">,</span>
        <span class="s2">&quot;./artifacts/trained_model_fp32_fwd_classifier.pkl&quot;</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>O pr√≥ximo passo √© instanciar o nosso <code>modelo</code> e atualizar o path do <code>Processor</code> (<code>./models/model.py</code>).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">processor.sp</span> <span class="kn">import</span> <span class="n">_fix_sp_processor</span>
<span class="kn">from</span> <span class="nn">fastai.text</span> <span class="kn">import</span> <span class="n">load_learner</span>
<span class="kn">from</span> <span class="nn">dotenv</span> <span class="kn">import</span> <span class="n">load_dotenv</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">gdown</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">load_dotenv</span><span class="p">()</span>

<span class="n">artifactsPath</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;artifactsPath&quot;</span><span class="p">))</span>
<span class="n">modelFileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;modelFileName&quot;</span><span class="p">)</span>
<span class="n">spModel</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;spmodelFileName&quot;</span><span class="p">)</span>
<span class="n">spVocab</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;spmodelVocabFileName&quot;</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">load_learner</span><span class="p">(</span><span class="n">artifactsPath</span><span class="p">,</span> <span class="n">modelFileName</span><span class="p">)</span>
<span class="n">_fix_sp_processor</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">artifactsPath</span><span class="p">,</span> <span class="n">spModel</span><span class="p">,</span> <span class="n">spVocab</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Por fim, podemos escrever a rota para consulta ao modelo (<code>./main.py</code>).</p>

</div>
</div>
</div>
    
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">inference.predict</span> <span class="kn">import</span> <span class="n">predict</span>
<span class="kn">from</span> <span class="nn">fastapi</span> <span class="kn">import</span> <span class="n">FastAPI</span><span class="p">,</span> <span class="n">HTTPException</span>
<span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">Ementa</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">ementa</span><span class="p">:</span> <span class="nb">str</span>

<span class="k">class</span> <span class="nc">Tags</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
    <span class="n">tags</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/predict&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">Tags</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">get_prediction</span><span class="p">(</span><span class="n">Ementa</span><span class="p">:</span> <span class="n">Ementa</span><span class="p">):</span>
    <span class="n">ementa</span> <span class="o">=</span> <span class="n">Ementa</span><span class="o">.</span><span class="n">ementa</span>

    <span class="n">predictions</span> <span class="o">=</span> <span class="n">predict</span><span class="p">(</span><span class="n">ementa</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">predictions</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span>
            <span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;N√£o foi poss√≠vel encontrar nenhuma tag apropriada.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">predictions</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;tags&quot;</span><span class="p">:</span> <span class="n">predictions</span><span class="p">}</span>
</pre></div>

    </div>
</div>
</div>

</div>
    

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Vamos iniciar a aplica√ß√£o.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/o-eu-analitico/images/copied_from_nb/img/backend-gov-data-product/start-local-backend.png" alt="local-backend" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Em seguida, vamos utilizar o <code>curl</code> para testar uma requisi√ß√£o e observar o retorno da <code>api</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/o-eu-analitico/images/copied_from_nb/img/backend-gov-data-product/curl-post-local-backend.png" alt="local-backend" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Excelente ü•≥! Temos o nosso modelo respondendo por meio da chamada de uma api. O pr√≥ximo passo √© dockerizar a aplica√ß√£o e subir o servi√ßo para produ√ß√£o üè≠.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Primeiramente, vamos reorganizar a nossa estrutura de diret√≥rios do projeto e criar um <code>Dockerfile</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">

<pre><code>.
|____app
| |____processor
| | |____encoder.py
| | |____sp.py
| |____.gitignore
| |____main.py
| |____inference
| | |____predict.py
| |____LICENSE
| |____README.md
| |____models
| | |____model.py
| | |____download.py
| |____artifacts
| |____requirements.txt
| |____.env
|____Dockerfile</code></pre>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A estrutura do <code>Dockerfile</code> est√° detalhada abaixo.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<div class="highlight"><pre><span></span><span class="k">FROM</span> <span class="s">python:3.7</span>

<span class="k">EXPOSE</span><span class="s"> 8081</span>

<span class="k">COPY</span> ./app /app
<span class="k">WORKDIR</span><span class="s"> /app</span>

<span class="k">RUN</span> pip install -r requirements.txt
<span class="k">RUN</span> python ./models/download.py

<span class="k">CMD</span> <span class="p">[</span><span class="s2">&quot;uvicorn&quot;</span><span class="p">,</span> <span class="s2">&quot;main:app&quot;</span><span class="p">,</span> <span class="s2">&quot;--host&quot;</span><span class="p">,</span> <span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="s2">&quot;--port&quot;</span><span class="p">,</span> <span class="s2">&quot;8081&quot;</span><span class="p">]</span>
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Iremos realizar o deploy da nossa api utilizando a <a href="https://azure.microsoft.com/pt-br/">Azure</a>. O primeiro passo √© fazer o <a href="https://azure.microsoft.com/pt-br/services/container-registry/">registro de uma imagem docker</a> (<em>docker registry</em>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/o-eu-analitico/images/copied_from_nb/img/backend-gov-data-product/register-docker-registry.png" alt="docker-registry" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A pr√≥xima etapa √© fazer o <code>build</code> da imagem <code>docker</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/o-eu-analitico/images/copied_from_nb/img/backend-gov-data-product/build-docker-image.png" alt="build-docker-image" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Para garantir que a aplica√ß√£o est√° funcionando adequadamente, vamos execut√°-la localmente.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/o-eu-analitico/images/copied_from_nb/img/backend-gov-data-product/start-local-docker-backend-api.png" alt="run-docker-image" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Da mesma forma realizada anteriormente, vamos realizar um <code>post</code> pelo <code>curl</code> e testar a <code>api</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/o-eu-analitico/images/copied_from_nb/img/backend-gov-data-product/test-api-dockerizada.png" alt="test-api-docker" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Obtivemos a confirma√ß√£o de funcionamento da api no ambiente <code>docker</code>. Agora, podemos fazer o <code>push</code> da imagem para a azure. A primeira etapa √© realizar a autentica√ß√£o no servi√ßo, pelo seguinte comando:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>docker login pylegalclassifier.azurecr.io</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ser√° aberto um prompt solicitando login e senha que pode ser encontrado no painel de administra√ß√£o da aplica√ß√£o. Finalizado a autentica√ß√£o, vamos fazer o push da imagem.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/o-eu-analitico/images/copied_from_nb/img/backend-gov-data-product/push-docker-image.png" alt="push-docker-image" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A pr√≥xima etapa √© a cria√ß√£o de um <a href="https://azure.microsoft.com/pt-br/services/app-service/web/">WebApp</a> no portal da Azure. Primeiramente, definimos o grupo de recursos o qual esse app far√° parte, em seguida definimos um nome para inst√¢ncia, bem como definimos que nossa aplica√ß√£o √© baseada em um container docker, e por √∫ltimo definimos a regi√£o onde ser√° alocado o recurso.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/o-eu-analitico/images/copied_from_nb/img/backend-gov-data-product/web-app-1.png" alt="web-app-1" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Para finalizar, na aba <code>Docker</code> selecionamos a imagem que registramos no <code>docker registry</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/o-eu-analitico/images/copied_from_nb/img/backend-gov-data-product/web-app-2.png" alt="web-app-2" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Ap√≥s confirmar todas informa√ß√µes, ser√° iniciado o <code>deploy</code> da nossa aplica√ß√£o e ap√≥s alguns minutos nossa api est√° em produ√ß√£o üöÄüöÄ!!!</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/o-eu-analitico/images/copied_from_nb/img/backend-gov-data-product/consulta-api-prod.png" alt="web-app-2" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><div class="tenor-gif-embed" data-postid="13347383" data-share-method="host" data-width="100%" data-aspect-ratio="1.0774647887323943"><a href="https://tenor.com/view/yes-baby-goal-funny-face-gif-13347383">Yes Baby GIF</a> from <a href="https://tenor.com/search/yes-gifs">Yes GIFs</a></div><script type="text/javascript" async="" src="https://tenor.com/embed.js"></script></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>O <em>framework</em> <code>fastapi</code> cria automaticamente uma documenta√ß√£o para suas apis, caso queiram visualizar esse recurso basta acessar <code>https://pylegalclassifier.azurewebsites.net/docs</code>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img src="/o-eu-analitico/images/copied_from_nb/img/backend-gov-data-product/api-docs.png" alt="api-docs" /></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>O nosso deploy üñ•Ô∏è est√° conclu√≠do! Estamos nos aproximando do final dessa s√©rie de postagens. Espero que voc√™s estejam aproveitando tanto quanto eu üôã‚Äç‚ôÇÔ∏è Assim, no pr√≥ximo post iremos construir um exemplo de aplica√ß√£o que pode fazer uso da nossa <code>api</code>. At√© mais ü§ò!!</p>

</div>
</div>
</div>
</div>



  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="netoferraz/o-eu-analitico"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/o-eu-analitico/deep%20learning/nlp/data%20product/fastapi/docker/cloud/azure/2020/08/03/gov-data-product-p5.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/o-eu-analitico/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/o-eu-analitico/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/o-eu-analitico/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>registros de uma jornada para uma vida mais data driven.</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/netoferraz" title="netoferraz"><svg class="svg-icon grey"><use xlink:href="/o-eu-analitico/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/zeneto" title="zeneto"><svg class="svg-icon grey"><use xlink:href="/o-eu-analitico/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
